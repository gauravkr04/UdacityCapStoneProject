# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2.1

jobs:
  lint:
    docker:
      - image: python:3.7.3-stretch
    steps:
      - checkout
      - run:
          name: install dependencies
          command: |
            python3 -m venv ~/.capstone
            source ~/.capstone/bin/activate
            make install
            # Install hadolint
            wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v1.16.3/hadolint-Linux-x86_64 &&\
            chmod +x /bin/hadolint
            
      - run:
          name: run lint
          command: |
            source ~/.capstone/bin/activate
            make lint
  
  create-docker-image:
    machine: true
    working_directory: ~/app
    steps:
      - checkout
      - run:
          name: Build, Test and Upload docker image
          command: |
            docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PWD}
            docker build -t gauravkr04/udacityblue1 .
            docker run -d --rm --name app -p 8081:8080 gauravkr04/udacityblue1:1.0.0
            sleep 5
            docker container ls

            docker push gauravkr04/udacityblue1:1.0.0
  
workflows:
  deployment:
    jobs:
      - lint
      - create-docker-image
          requires:
            - lint

